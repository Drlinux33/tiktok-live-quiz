<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Quiz Game</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --fg: #ffffff;
            --accent: #ff2d55;
            --success: #34c759;
            --warning: #ffcc00;
            --error: #ff3b30;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--fg);
            line-height: 1.6;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .game-panel {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
        }

        .sidebar {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            overflow-y: auto;
        }

        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: var(--error);
        }

        .connection-status.connected {
            background: var(--success);
        }

        button {
            background: var(--accent);
            color: var(--fg);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input, textarea {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--fg);
            padding: 0.5rem;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .leaderboard {
            margin-top: 1rem;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .answer-log {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .answer-log-item {
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .winner-animation {
            animation: winner 1s ease-in-out;
        }

        @keyframes winner {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .tiktok-iframe {
            width: 100%;
            height: 200px;
            border: none;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .winner-message {
            font-size: 1.2em;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="connection-controls">
            <span class="connection-status"></span>
            <input type="text" id="username" placeholder="TikTok Username" value="al9saqr">
            <button id="connectBtn">اتصال</button>
            <button id="disconnectBtn" disabled>قطع الاتصال</button>
            <button id="testModeBtn">وضع الاختبار</button>
        </div>
        <iframe id="tiktokChat" class="tiktok-iframe"></iframe>
    </header>

    <main class="game-panel">
        <div class="question-controls">
            <h2>السؤال الحالي</h2>
            <textarea id="questionText" rows="3" placeholder="اكتب السؤال هنا"></textarea>
            <input type="text" id="correctAnswer" placeholder="الإجابة الصحيحة">
            <button id="sendQuestion">إرسال السؤال (Ctrl+Enter)</button>
            <button id="endQuestion">إنهاء السؤال (Ctrl+E)</button>
        </div>

        <div class="current-game-status">
            <h3>الحالة الحالية</h3>
            <p>السؤال رقم: <span id="questionNumber">0</span>/<span id="totalQuestions">10</span></p>
            <div id="currentWinner"></div>
        </div>
    </main>

    <aside class="sidebar">
        <div class="leaderboard">
            <h2>لوحة المتصدرين</h2>
            <button id="resetScores">إعادة تصفير النقاط</button>
            <button id="exportCSV">تصدير CSV</button>
            <div id="leaderboardList"></div>
        </div>

        <div class="answer-log">
            <h2>آخر الإجابات</h2>
            <div id="answerLogList"></div>
        </div>
    </aside>

    <script>
        // Game Engine Module
        const GameEngine = {
            connected: false,
            currentQuestion: null,
            scores: new Map(),
            answerLog: [],
            ws: null,
            testMode: false,
            testInterval: null,
            messageHandler: null,

            init() {
                this.loadFromLocalStorage();
                this.setupEventListeners();
                this.setupMessageListener();
                this.updateUI();
            },

            setupMessageListener() {
                window.addEventListener('message', (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'chat') {
                            const username = data.nickname;
                            const message = data.comment;
                            if (this.currentQuestion && !this.currentQuestion.winner) {
                                console.log(`تم استلام إجابة من ${username}: ${message}`);
                                this.handleAnswer(username, message);
                            }
                        }
                    } catch (e) {
                        console.log('رسالة غير صالحة:', e);
                    }
                });
            },

            connect(username) {
                const url = `https://tiktok-chat-reader.zerody.one/obs.html?username=${username}&showLikes=1&showChats=1&showGifts=1&showFollows=1&showJoins=1&bgColor=rgb(24,23,28)&fontColor=rgb(227,229,235)&fontSize=1.3em`;
                document.getElementById('tiktokChat').src = url;
                this.connected = true;
                this.updateUI();
                this.saveToLocalStorage();
            },

            disconnect() {
                document.getElementById('tiktokChat').src = '';
                this.connected = false;
                this.updateUI();
            },

            sendQuestion(question, answer) {
                if (!question || !answer || answer.length < 2) return false;
                
                this.currentQuestion = {
                    text: question,
                    answer: this.normalizeText(answer),
                    winner: null,
                    timestamp: Date.now()
                };

                this.updateUI();
                return true;
            },

            endQuestion() {
                if (!this.currentQuestion) return;
                this.currentQuestion = null;
                this.updateUI();
            },

            handleAnswer(username, answer) {
                if (!this.currentQuestion || this.currentQuestion.winner) return;

                console.log('التحقق من الإجابة:', {
                    username,
                    answer,
                    normalizedAnswer: this.normalizeText(answer),
                    correctAnswer: this.currentQuestion.answer
                });

                const normalizedAnswer = this.normalizeText(answer);
                if (normalizedAnswer === this.currentQuestion.answer) {
                    console.log(`إجابة صحيحة من ${username}!`);
                    this.currentQuestion.winner = username;
                    this.addScore(username);
                    
                    const audio = new Audio('data:audio/mp3;base64,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');
                    audio.play().catch(() => {});
                    
                    this.updateUI();
                    
                    const winnerMessage = document.createElement('div');
                    winnerMessage.className = 'winner-message';
                    winnerMessage.innerHTML = `
                        <div style="
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: var(--accent);
                            padding: 20px;
                            border-radius: 10px;
                            text-align: center;
                            animation: fadeInOut 3s forwards;
                            z-index: 1000;
                        ">
                            <h2>🎉 تهانينا! 🎉</h2>
                            <p>الفائز: ${username}</p>
                            <p>الإجابة الصحيحة: ${answer}</p>
                        </div>
                    `;
                    document.body.appendChild(winnerMessage);
                    setTimeout(() => winnerMessage.remove(), 3000);
                }

                this.addToAnswerLog(username, answer);
            },

            normalizeText(text) {
                return text
                    .toLowerCase()
                    .replace(/[\\u0600-\\u06FF]/g, c => c.normalize('NFKD'))
                    .replace(/[^\\w\\s]/g, '')
                    .replace(/\\s+/g, ' ')
                    .trim();
            },

            addScore(username) {
                const currentScore = this.scores.get(username) || 0;
                this.scores.set(username, currentScore + 1);
                this.saveToLocalStorage();
            },

            resetScores() {
                if (!confirm('هل أنت متأكد من إعادة تصفير النقاط؟')) return;
                this.scores.clear();
                this.saveToLocalStorage();
                this.updateUI();
            },

            addToAnswerLog(username, answer) {
                this.answerLog.unshift({ username, answer, timestamp: Date.now() });
                this.answerLog = this.answerLog.slice(0, 5);
                this.updateUI();
            },

            exportCSV() {
                const csv = [
                    'Username,Score,LastWin',
                    ...Array.from(this.scores.entries()).map(([user, score]) => 
                        `"${user}",${score},${new Date().toISOString()}`
                )].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'leaderboard.csv';
                a.click();
                URL.revokeObjectURL(url);
            },

            toggleTestMode() {
                this.testMode = !this.testMode;
                if (this.testMode) {
                    this.testInterval = setInterval(() => {
                        const testUsers = ['user1', 'user2', 'user3', 'user4'];
                        const testAnswers = ['test1', 'test2', this.currentQuestion?.answer || 'correct'];
                        const randomUser = testUsers[Math.floor(Math.random() * testUsers.length)];
                        const randomAnswer = testAnswers[Math.floor(Math.random() * testAnswers.length)];
                        this.handleAnswer(randomUser, randomAnswer);
                    }, 2000);
                } else {
                    clearInterval(this.testInterval);
                }
                document.getElementById('testModeBtn').textContent = 
                    this.testMode ? 'إيقاف وضع الاختبار' : 'وضع الاختبار';
            },

            saveToLocalStorage() {
                const data = {
                    scores: Array.from(this.scores.entries()),
                    username: document.getElementById('username').value
                };
                localStorage.setItem('tikTokQuizGame', JSON.stringify(data));
            },

            loadFromLocalStorage() {
                try {
                    const data = JSON.parse(localStorage.getItem('tikTokQuizGame'));
                    if (data) {
                        this.scores = new Map(data.scores);
                        document.getElementById('username').value = data.username || 'al9saqr';
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
            },

            updateUI() {
                document.querySelector('.connection-status').classList.toggle('connected', this.connected);
                document.getElementById('connectBtn').disabled = this.connected;
                document.getElementById('disconnectBtn').disabled = !this.connected;

                const currentWinner = document.getElementById('currentWinner');
                if (this.currentQuestion) {
                    currentWinner.textContent = this.currentQuestion.winner ? 
                        `الفائز: ${this.currentQuestion.winner}` : 'لم يتم تحديد فائز بعد';
                    if (this.currentQuestion.winner) {
                        currentWinner.classList.add('winner-animation');
                        setTimeout(() => currentWinner.classList.remove('winner-animation'), 1000);
                    }
                } else {
                    currentWinner.textContent = '';
                }

                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = Array.from(this.scores.entries())
                    .sort(([,a], [,b]) => b - a)
                    .map(([user, score]) => `
                        <div class="leaderboard-item">
                            <span>${user}</span>
                            <span>${score} نقطة</span>
                        </div>
                    `).join('');

                const answerLogList = document.getElementById('answerLogList');
                answerLogList.innerHTML = this.answerLog.map(({username, answer}) => `
                    <div class="answer-log-item">
                        <strong>${username}:</strong> ${answer}
                    </div>
                `).join('');
            },

            setupEventListeners() {
                document.getElementById('connectBtn').onclick = () => {
                    const username = document.getElementById('username').value;
                    this.connect(username);
                };

                document.getElementById('disconnectBtn').onclick = () => this.disconnect();
                document.getElementById('testModeBtn').onclick = () => this.toggleTestMode();
                document.getElementById('resetScores').onclick = () => this.resetScores();
                document.getElementById('exportCSV').onclick = () => this.exportCSV();

                document.getElementById('sendQuestion').onclick = () => {
                    const question = document.getElementById('questionText').value;
                    const answer = document.getElementById('correctAnswer').value;
                    this.sendQuestion(question, answer);
                };

                document.getElementById('endQuestion').onclick = () => this.endQuestion();

                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        document.getElementById('sendQuestion').click();
                    } else if (e.ctrlKey && e.key === 'e') {
                        document.getElementById('endQuestion').click();
                    } else if (e.ctrlKey && e.key === 'r') {
                        document.getElementById('resetScores').click();
                    }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => GameEngine.init());
    </script>
</body>
</html>